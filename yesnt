-- ILO UI Library — Template-aware rewrite (uses your provided GUI structure exactly)
-- Drop this in as a single loadstring. It will use existing ScreenGui -> Window template if present.
-- Default theme color (used only for themeable elements): orange (255,165,0)
-- Author: revised for you (preserves original visuals & text colors)

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

local localPlayer = Players.LocalPlayer
local playerGui = localPlayer:WaitForChild("PlayerGui")

-- FS helpers (safe)
local writefile_fn, readfile_fn, isfolder_fn, makefolder_fn, listfiles_fn
if writefile  then writefile_fn = writefile end
if readfile   then readfile_fn  = readfile end
if isfolder   then isfolder_fn  = isfolder end
if makefolder then makefolder_fn = makefolder end
if listfiles  then listfiles_fn = listfiles end

local function safe_makefolder(path)
    if isfolder_fn and makefolder_fn then
        if not isfolder_fn(path) then
            pcall(function() makefolder_fn(path) end)
        end
    elseif makefolder_fn then
        pcall(function() makefolder_fn(path) end)
    end
end
local function safe_writefile(path, contents)
    if writefile_fn then
        pcall(function() writefile_fn(path, contents) end)
        return true
    end
    return false
end
local function safe_readfile(path)
    if readfile_fn then
        local ok, res = pcall(function() return readfile_fn(path) end)
        if ok then return res end
    end
    return nil
end
local function safe_listfiles(path)
    if listfiles_fn then
        local ok, res = pcall(function() return listfiles_fn(path) end)
        if ok then return res end
    end
    return {}
end

-- Defaults
local DEFAULT_THEME = Color3.fromRGB(255,165,0)
local THEME = DEFAULT_THEME
local CFG_ROOT = "ILO"
local CFG_FOLDER = CFG_ROOT.."/cfgs"

local function clamp(n,a,b) return math.max(a, math.min(b, n)) end

-- Utility: create instance helper (tries to set properties safely)
local function new(class, props)
    local inst = Instance.new(class)
    if props then
        for k,v in pairs(props) do
            pcall(function() inst[k] = v end)
        end
    end
    return inst
end

-- Deep tween transparency for entire UI (affects BackgroundTransparency, TextTransparency, ImageTransparency, UIStroke.Transparency)
local function deepTweenTransparency(root, targetTransparency, tweenInfo)
    tweenInfo = tweenInfo or TweenInfo.new(0.22, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tweens = {}
    local function collect(obj)
        if obj:IsA("GuiObject") then
            local goals = {}
            if obj:FindFirstChildOfClass("UIStroke") then
                -- UIStroke only has Transparency property on the stroke object itself
                local stroke = obj:FindFirstChildOfClass("UIStroke")
                if stroke then
                    table.insert(tweens, TweenService:Create(stroke, tweenInfo, {Transparency = targetTransparency}))
                end
            end
            -- background
            if obj.BackgroundTransparency ~= nil then goals.BackgroundTransparency = targetTransparency end
            -- text
            if obj:IsA("TextLabel") or obj:IsA("TextBox") or obj:IsA("TextButton") then goals.TextTransparency = targetTransparency end
            -- image
            if obj:IsA("ImageLabel") or obj:IsA("ImageButton") then goals.ImageTransparency = targetTransparency end
            if next(goals) then
                table.insert(tweens, TweenService:Create(obj, tweenInfo, goals))
            end
        end
        for _,c in ipairs(obj:GetChildren()) do collect(c) end
    end
    collect(root)
    for _,t in ipairs(tweens) do pcall(function() t:Play() end) end
end

-- Dragging: top area height (px)
local DRAG_TOP = 36

-- Detect or create template
local function getOrCreateTemplate()
    -- Attempt to find an existing ScreenGui that matches your template (Window frame inside)
    local screenGui = nil
    for _,child in ipairs(playerGui:GetChildren()) do
        if child:IsA("ScreenGui") and child:FindFirstChild("Window") then
            screenGui = child
            break
        end
    end
    if not screenGui then
        -- Build the exact template you provided (keeps naming identical)
        screenGui = new("ScreenGui",{Parent = playerGui, Name = "ILO_UI_Template", ZIndexBehavior = Enum.ZIndexBehavior.Sibling, ResetOnSpawn = false})
        -- Build Window
        local Window = new("Frame", {Parent = screenGui, Name = "Window", BackgroundColor3 = Color3.fromRGB(21,21,21), BorderSizePixel=0, Size = UDim2.new(0,612,0,482), Position = UDim2.new(0.173,0,0.08346,0)})
        -- SideBar
        local SideBar = new("Frame",{Parent=Window, Name="SideBar", BackgroundColor3=Color3.fromRGB(43,43,43), BorderSizePixel=0, Size = UDim2.new(0,100,0,482), Position = UDim2.new(0,0,0,0)})
        local CheatCover = new("ImageLabel",{Parent=SideBar, Name="CheatCover", Image="rbxassetid://76540169874404", BackgroundTransparency=1, Size=UDim2.new(0,83,0,91), Position=UDim2.new(0.08,0,0.04979,0)})
        new("UIAspectRatioConstraint",{Parent=CheatCover})
        -- Tabs
        local names = {"HomeTab","LegitTab","RageTab","HvHTab","VisualsTab","MiscTab"}
        local yPositions = {0.25726,0.3444,0.43154,0.51867,0.59959,0.68672}
        for i,name in ipairs(names) do
            local tb = new("TextButton",{Parent=SideBar, Name=name, TextColor3 = Color3.new(1,1,1), BackgroundTransparency = 1, Text = name:gsub("Tab",""), TextSize = 21, Size = UDim2.new(0,44,0,28)})
            tb.Position = UDim2.new(0.27,0,yPositions[i],0)
            tb.FontFace = Font.new([[rbxasset://fonts/families/SourceSansPro.json]], Enum.FontWeight.Regular, Enum.FontStyle.Normal)
        end
        local ActiveTab = new("Frame",{Parent=SideBar, Name="ActiveTab", BackgroundColor3=Color3.fromRGB(15,102,166), Size=UDim2.new(0,44,0,2), Position = UDim2.new(0.28,0,0.31328,0)})
        -- Section (left main)
        local Section = new("Frame",{Parent=Window, Name="Section", BackgroundColor3=Color3.fromRGB(36,36,36), Size=UDim2.new(0,202,0,416), Position=UDim2.new(0.23039,0,0.09544,0)})
        local SectionName = new("Frame",{Parent=Section, Name="SectionName", BackgroundColor3=Color3.fromRGB(15,102,166), Size=UDim2.new(0,202,0,30), Position=UDim2.new(0,0,-0.07212,0)})
        new("TextLabel",{Parent=SectionName, Name="TextLabel", BackgroundTransparency=1, TextColor3=Color3.new(1,1,1), Text="Example", Size=UDim2.new(0,200,0,30), TextSize=14})
        -- Example controls (same as your template)
        new("TextButton",{Parent=Section, Name="ToggleButton", Size=UDim2.new(0,12,0,13), Position=UDim2.new(0.08416,0,0.04808,0), BackgroundColor3=Color3.fromRGB(43,43,43), Text=""})
        new("UIAspectRatioConstraint",{Parent=Section.ToggleButton})
        new("TextLabel",{Parent=Section.ToggleButton, Name="ToggleName", BackgroundTransparency=1, TextColor3=Color3.new(1,1,1), Text="Feature1", Position=UDim2.new(3.08333,0,-0.08333,0)})
        local DropDownButton = new("TextButton",{Parent=Section, Name="DropDownButton", Size=UDim2.new(0,104,0,17), Position=UDim2.new(0.14356,0,0.14663,0), BackgroundColor3=Color3.fromRGB(43,43,43), Text=""})
        new("TextLabel",{Parent=DropDownButton, Name="DropdownName", BackgroundTransparency=1, TextColor3=Color3.new(1,1,1), Text="Feature", Position=UDim2.new(0.16346,0,-0.90653,0)})
        local DropDownFrame = new("Frame",{Parent=DropDownButton, Name="DropDownFrame", BackgroundColor3=Color3.fromRGB(43,43,43), Visible=false, Size=UDim2.new(0,104,0,69), Position=UDim2.new(0,0,1,0)})
        for i,opt in ipairs({"option1","option2","option3","option4"}) do
            new("TextButton",{Parent=DropDownFrame, Name="option"..i, Text=opt, Size=UDim2.new(0,104,0,17), Position = UDim2.new(0,0,(i-1)/4,0), BackgroundColor3=Color3.fromRGB(43,43,43), TextColor3 = Color3.new(1,1,1)})
        end
        local Button = new("TextButton",{Parent=Section, Name="Button", Size=UDim2.new(0,104,0,24), Position=UDim2.new(0.14356,0,0.23077,0), BackgroundColor3=Color3.fromRGB(43,43,43), TextColor3=Color3.fromRGB(15,102,166), FontFace = Font.new([[rbxasset://fonts/families/SourceSansPro.json]], Enum.FontWeight.Bold), Text="Feature"})
        local Slider = new("Frame",{Parent=Section, Name="Slider", BackgroundColor3=Color3.fromRGB(43,43,43), Size=UDim2.new(0,137,0,9), Position=UDim2.new(0.14356,0,0.36779,0)})
        local sliderKnob = new("TextButton",{Parent=Slider, Name="sliderKnob", Size=UDim2.new(0,7,0,21), Position=UDim2.new(-0.05109,0,-0.66667,0), BackgroundColor3=Color3.fromRGB(15,102,166)})
        new("TextLabel",{Parent=Slider, Name="SliderValue", BackgroundTransparency=1, TextColor3=Color3.new(1,1,1), Text="0.0 %", Size=UDim2.new(0,33,0,12), Position=UDim2.new(0.75912,0,-2,0)})
        -- Bind, ColorPicker placeholders
        new("TextButton",{Parent=Section, Name="ColorPicker", Size=UDim2.new(0,39,0,18), Position=UDim2.new(0.10891,0,0.44712,0), BackgroundColor3=Color3.new(1,1,1)})
        new("TextButton",{Parent=Section, Name="Bind", Size=UDim2.new(0,10,0,12), Position=UDim2.new(0.10891,0,0.6851,0), BackgroundColor3=Color3.fromRGB(43,43,43), Text="..."})
        local BindOptions = new("Frame",{Parent=Section.Bind, Name="BindOptions", Visible=false, BackgroundColor3=Color3.fromRGB(43,43,43), Size=UDim2.new(0,85,0,54), Position=UDim2.new(1.6,0,-3.5,0)})
        new("TextButton",{Parent=BindOptions, Name="Hold", BackgroundTransparency=1, Text="Hold", Size=UDim2.new(0,85,0,19)})
        new("TextButton",{Parent=BindOptions, Name="Toggle", BackgroundTransparency=1, Text="Toggle", Size=UDim2.new(0,85,0,19), Position=UDim2.new(0,0,0.29057,0)})
        new("TextButton",{Parent=BindOptions, Name="Always", BackgroundTransparency=1, Text="Always", Size=UDim2.new(0,85,0,19), Position=UDim2.new(0,0,0.64983,0)})
        -- MultiSection
        local MultiSection = new("Frame",{Parent=Window, Name="MultiSection", BackgroundColor3=Color3.fromRGB(36,36,36), Size=UDim2.new(0,202,0,416), Position=UDim2.new(0.61765,0,0.09544,0)})
        new("TextButton",{Parent=MultiSection, Text="1", Size=UDim2.new(0,68,0,34), Position=UDim2.new(0.66337,0,-0.07212,0), BackgroundColor3=Color3.fromRGB(43,43,41), TextColor3=Color3.new(1,1,1)})
        new("TextButton",{Parent=MultiSection, Text="2", Size=UDim2.new(0,68,0,34), Position=UDim2.new(0,0,-0.07212,0), BackgroundColor3=Color3.fromRGB(43,43,41), TextColor3=Color3.new(1,1,1)})
        new("TextButton",{Parent=MultiSection, Text="3", Size=UDim2.new(0,68,0,34), Position=UDim2.new(0.32673,0,-0.07212,0), BackgroundColor3=Color3.fromRGB(43,43,41), TextColor3=Color3.new(1,1,1)})
        new("Frame",{Parent=MultiSection, BackgroundColor3=Color3.fromRGB(15,102,166), Size=UDim2.new(0,202,0,2), Position=UDim2.new(0,0,0.00481,0)})
    end

    -- find the ScreenGui we will use (prefer one with a Window child)
    local screenGui = nil
    for _, child in ipairs(playerGui:GetChildren()) do
        if child:IsA("ScreenGui") and child:FindFirstChild("Window") then
            screenGui = child
            break
        end
    end
    if not screenGui then
        -- maybe the function above created one; search again
        for _, child in ipairs(playerGui:GetChildren()) do
            if child:IsA("ScreenGui") and child:FindFirstChild("Window") then
                screenGui = child
                break
            end
        end
    end
    return screenGui
end

local ScreenGui = getOrCreateTemplate()
local Window = ScreenGui:FindFirstChild("Window")
assert(Window, "Window frame not found or failed to create template")

-- store state
local ILO = {}
ILO._tabs = {}
ILO._sections = {}
ILO._theme = DEFAULT_THEME
ILO._open = true -- start open
ILO._toggles = {}
ILO._sliders = {}
ILO._dropdowns = {}
ILO._binds = {}
ILO._colorpickers = {}
ILO._configDropdown = nil

-- Helper: get child by name safely
local function childOf(parent, name)
    if not parent then return nil end
    local c = parent:FindFirstChild(name)
    return c
end

-- DRAGGING implementation (drag top DRAG_TOP px of Window)
do
    local dragging, dragStart, startPos
    Window.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            local y = input.Position.Y - Window.AbsolutePosition.Y
            if y <= DRAG_TOP then
                dragging = true
                dragStart = input.Position
                startPos = Window.Position
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then dragging = false end
                end)
            end
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            local newX = startPos.X.Scale + (startPos.X.Offset + delta.X - startPos.X.Offset) / math.max(1, Window.Parent.AbsoluteSize.X)
            local newY = startPos.Y.Scale + (startPos.Y.Offset + delta.Y - startPos.Y.Offset) / math.max(1, Window.Parent.AbsoluteSize.Y)
            -- preserve pixel offsets relative to screen size (use AbsoluteOffset approach)
            local newPos = UDim2.new(0, startPos.X.Offset + delta.X, 0, startPos.Y.Offset + delta.Y)
            Window.Position = newPos
        end
    end)
end

-- Fade functions (open/close)
function ILO:FadeOpen()
    self._open = true
    Window.Visible = true
    deepTweenTransparency(Window, 0, TweenInfo.new(0.22, Enum.EasingStyle.Quad, Enum.EasingDirection.Out))
end
function ILO:FadeClose()
    self._open = false
    deepTweenTransparency(Window, 1, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.In))
    delay(0.2, function() pcall(function() Window.Visible = false end) end)
end
function ILO:Toggle()
    if self._open then self:FadeClose() else self:FadeOpen() end
end

-- default key: Delete
do
    local toggleKey = Enum.KeyCode.Delete
    UserInputService.InputBegan:Connect(function(input, gpe)
        if gpe then return end
        if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == toggleKey then
            ILO:Toggle()
        end
    end)
end

-- ActiveTab movement (uses template ActiveTab)
local ActiveTab = childOf(Window:FindFirstChild("SideBar"), "ActiveTab")

-- map existing side bar tab buttons into ILO._tabs
do
    local sideBar = Window:FindFirstChild("SideBar")
    if sideBar then
        for _, child in ipairs(sideBar:GetChildren()) do
            if child:IsA("TextButton") and child.Name:match("Tab$") then
                -- create a tab object that shows/hides the Section frame contents
                local tabName = child.Name
                local human = child.Text ~= "" and child.Text or tabName:gsub("Tab","")
                local tab = {Name = human, Button = child}
                -- when clicked, hide other Sections and show the Section frame
                child.MouseButton1Click:Connect(function()
                    -- move ActiveTab under this button
                    if ActiveTab then
                        ActiveTab.Position = UDim2.new(child.Position.X.Scale, child.Position.X.Offset, child.Position.Y.Scale + child.Size.Y.Scale - 0.02, child.Position.Y.Offset)
                        ActiveTab.Size = UDim2.new(child.Size.X.Scale, child.Size.X.Offset, 0, 2)
                    end
                    -- show/hide Sections: if you have per-tab sections we would show them. For now, we'll show the left Section and MultiSection as needed
                    -- Keep behaviour minimal: show Section by default
                    local Section = Window:FindFirstChild("Section")
                    if Section then Section.Visible = true end
                    local Multi = Window:FindFirstChild("MultiSection")
                    if Multi then Multi.Visible = true end
                end)
                table.insert(ILO._tabs, tab)
            end
        end
    end
    -- ensure ActiveTab starts under first tab if present
    if ActiveTab and #ILO._tabs > 0 then
        local b = ILO._tabs[1].Button
        ActiveTab.Position = UDim2.new(b.Position.X.Scale, b.Position.X.Offset, b.Position.Y.Scale + b.Size.Y.Scale - 0.02, b.Position.Y.Offset)
        ActiveTab.Size = UDim2.new(b.Size.X.Scale, b.Size.X.Offset, 0, 2)
    end
end

-- Color picker (modal) that uses your ScreenGui as parent (reuses template ColorPicker as base if needed)
local function CreateColorPickerModal()
    -- We'll create a single modal and reuse it
    local modal = ScreenGui:FindFirstChild("ILO_ColorModal")
    if modal then return modal end
    modal = new("Frame", {Parent = ScreenGui, Name = "ILO_ColorModal", Size = UDim2.new(0,360,0,240), AnchorPoint = Vector2.new(0.5,0.5), Position = UDim2.new(0.5,0,0.5,0), BackgroundColor3 = Color3.fromRGB(43,43,43), BorderSizePixel = 1, Visible = false, ZIndex = 1000})
    new("TextLabel", {Parent = modal, Text = "Color Picker", Size = UDim2.new(1,0,0,26), BackgroundTransparency = 1, TextColor3 = Color3.new(1,1,1)})
    -- SV box and hue bar
    local sv = new("Frame",{Parent=modal, Size=UDim2.new(0,200,0,160), Position=UDim2.new(0,10,0,36), BackgroundColor3 = Color3.new(1,0,0)})
    local hue = new("Frame",{Parent=modal, Size=UDim2.new(0,20,0,160), Position=UDim2.new(0,220,0,36)})
    local hueGrad = Instance.new("UIGradient", hue)
    hueGrad.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromHSV(0,1,1)),
        ColorSequenceKeypoint.new(0.17, Color3.fromHSV(60/360,1,1)),
        ColorSequenceKeypoint.new(0.33, Color3.fromHSV(120/360,1,1)),
        ColorSequenceKeypoint.new(0.5, Color3.fromHSV(180/360,1,1)),
        ColorSequenceKeypoint.new(0.67, Color3.fromHSV(240/360,1,1)),
        ColorSequenceKeypoint.new(0.83, Color3.fromHSV(300/360,1,1)),
        ColorSequenceKeypoint.new(1, Color3.fromHSV(360/360,1,1)),
    })
    local preview = new("Frame",{Parent=modal, Size=UDim2.new(0,100,0,40), Position=UDim2.new(0,10,0,200-40), BackgroundColor3=Color3.new(1,1,1)})
    local rgbBox = new("TextBox",{Parent=modal, Size=UDim2.new(0,200,0,22), Position=UDim2.new(0,10,0,200-18), Text="255 165 0", ClearTextOnFocus=false, BackgroundColor3=Color3.new(1,1,1), TextColor3=Color3.new(0,0,0)})
    local btnSelect = new("TextButton",{Parent=modal, Size=UDim2.new(0,70,0,26), Position=UDim2.new(1,-80,0,200-18), Text="Select", BackgroundColor3=THEME, TextColor3=Color3.new(1,1,1)})
    local btnCancel = new("TextButton",{Parent=modal, Size=UDim2.new(0,70,0,26), Position=UDim2.new(1,-160,0,200-18), Text="Cancel", BackgroundColor3=Color3.fromRGB(60,60,60), TextColor3=Color3.new(1,1,1)})
    -- state
    local h = 0; local s = 1; local v = 1
    local function updatePreview()
        local c = Color3.fromHSV(h,s,v)
        preview.BackgroundColor3 = c
        rgbBox.Text = string.format("%d %d %d", math.floor(c.R*255+0.5), math.floor(c.G*255+0.5), math.floor(c.B*255+0.5))
    end
    updatePreview()
    -- simple pointer handling
    local editingHue, editingSV = false, false
    hue.InputBegan:Connect(function(input) if input.UserInputType==Enum.UserInputType.MouseButton1 then editingHue = true end end)
    hue.InputEnded:Connect(function(input) if input.UserInputType==Enum.UserInputType.MouseButton1 then editingHue = false end end)
    sv.InputBegan:Connect(function(input) if input.UserInputType==Enum.UserInputType.MouseButton1 then editingSV = true end end)
    sv.InputEnded:Connect(function(input) if input.UserInputType==Enum.UserInputType.MouseButton1 then editingSV = false end end)
    UserInputService.InputChanged:Connect(function(inp)
        if editingHue and inp.UserInputType==Enum.UserInputType.MouseMovement then
            local mouse = UserInputService:GetMouseLocation()
            local rel = clamp((mouse.Y - hue.AbsolutePosition.Y)/hue.AbsoluteSize.Y, 0, 1)
            h = 1 - rel
            updatePreview()
        end
        if editingSV and inp.UserInputType==Enum.UserInputType.MouseMovement then
            local mouse = UserInputService:GetMouseLocation()
            local rx = clamp((mouse.X - sv.AbsolutePosition.X)/sv.AbsoluteSize.X, 0, 1)
            local ry = clamp((mouse.Y - sv.AbsolutePosition.Y)/sv.AbsoluteSize.Y, 0, 1)
            s = rx; v = 1 - ry
            updatePreview()
        end
    end)
    rgbBox.FocusLost:Connect(function()
        local r,g,b = rgbBox.Text:match("(%d+)%s+(%d+)%s+(%d+)")
        if r and g and b then
            local c = Color3.fromRGB(clamp(tonumber(r),0,255), clamp(tonumber(g),0,255), clamp(tonumber(b),0,255))
            h,s,v = Color3.toHSV(c)
            updatePreview()
        end
    end)
    -- API
    local API = {}
    function API:Open(initial)
        if initial then
            h,s,v = Color3.toHSV(initial)
            updatePreview()
        end
        modal.Visible = true
        modal.ZIndex = 1000
    end
    function API:Close() modal.Visible = false end
    function API:GetColor() return preview.BackgroundColor3 end
    API.SelectButton = btnSelect
    API.CancelButton = btnCancel
    return API
end

-- Toggle, Slider, Dropdown creation functions that add controls into Section frame
local SectionFrame = Window:FindFirstChild("Section")
local MultiSection = Window:FindFirstChild("MultiSection")

-- Keep list of added items (for config snapshot)
local addedControls = {}

-- Create Toggle (preserves visuals from template)
local function CreateToggle(labelText, opts)
    opts = opts or {}
    local parent = SectionFrame
    local holder = new("TextButton",{Parent=parent, Size=UDim2.new(1,-16,0,22), BackgroundColor3=Color3.fromRGB(43,43,43), BorderSizePixel=1, Text=""})
    local nameLabel = new("TextLabel",{Parent=holder, Text=labelText, BackgroundTransparency=1, Position=UDim2.new(0.08,0,0,0), Size=UDim2.new(0.7,0,1,0), TextColor3=Color3.new(1,1,1), TextSize=17})
    local switch = new("Frame",{Parent=holder, Size=UDim2.new(0,12,0,13), Position=UDim2.new(0.02,0,0.12,0), BackgroundColor3=Color3.fromRGB(43,43,43), BorderSizePixel=1})
    local switchFill = new("Frame",{Parent=switch, Size=UDim2.new(0,10,0,11), BackgroundColor3=Color3.new(1,1,1)})
    local colorBtn, bindBtn
    if opts.ColorPicker then
        colorBtn = new("TextButton",{Parent=holder, Size=UDim2.new(0,36,0,18), Position=UDim2.new(1,-42,0.12,0), BackgroundColor3=opts.Color or Color3.new(1,1,1)})
    end
    if opts.Bind then
        bindBtn = new("TextButton",{Parent=holder, Size=UDim2.new(0,26,0,18), Position=UDim2.new(1,-84,0.12,0), Text="...", BackgroundColor3=Color3.fromRGB(43,43,43), TextColor3=Color3.new(1,1,1)})
    end

    local state = opts.Default or false
    local cb = opts.Callback
    local assignedBind = nil
    local assignedColor = opts.Color or Color3.new(1,1,1)

    local function refresh()
        if state then
            switchFill.BackgroundColor3 = THEME
        else
            switchFill.BackgroundColor3 = Color3.new(1,1,1)
        end
        if colorBtn then colorBtn.BackgroundColor3 = assignedColor end
        if bindBtn then bindBtn.TextColor3 = Color3.new(1,1,1) end
    end
    holder.MouseButton1Click:Connect(function()
        state = not state
        pcall(cb, state)
        refresh()
    end)

    -- color picker
    if colorBtn then
        local cp = CreateColorPickerModal()
        cp.SelectButton.MouseButton1Click:Connect(function()
            local c = cp:GetColor()
            assignedColor = c
            cp:Close()
            refresh()
        end)
        cp.CancelButton.MouseButton1Click:Connect(function() cp:Close() end)
        colorBtn.MouseButton1Click:Connect(function() cp:Open(assignedColor) end)
        colorBtn.BackgroundColor3 = assignedColor
    end

    -- bind capture
    if bindBtn then
        local capturing = false
        bindBtn.MouseButton1Click:Connect(function()
            capturing = true
            bindBtn.Text = "..."
            local conn
            conn = UserInputService.InputBegan:Connect(function(input, gpe)
                if gpe then return end
                if capturing then
                    assignedBind = input
                    bindBtn.Text = assignedBind.KeyCode and tostring(assignedBind.KeyCode) or tostring(assignedBind.UserInputType)
                    capturing = false
                    conn:Disconnect()
                end
            end)
        end)
        -- toggle with assignedBind
        UserInputService.InputBegan:Connect(function(input, gpe)
            if gpe then return end
            if assignedBind and input.UserInputType == assignedBind.UserInputType and ((assignedBind.KeyCode and input.KeyCode == assignedBind.KeyCode) or (assignedBind.UserInputType == input.UserInputType and not assignedBind.KeyCode)) then
                state = not state
                pcall(cb, state)
                refresh()
            end
        end)
    end

    refresh()
    table.insert(addedControls, {type="toggle", get=function() return state end, set=function(v) state = not not v; refresh() end})
    return {
        Get = function() return state end,
        Set = function(v) state = not not v; refresh() end,
        SetColor = function(c) assignedColor = c; refresh() end,
        SetBind = function(b) assignedBind = b; refresh() end,
        UI = holder
    }
end

-- Create Button
local function CreateButton(text, callback)
    local parent = SectionFrame
    local btn = new("TextButton",{Parent=parent, Text=text, Size=UDim2.new(0,104,0,24), Position=UDim2.new(0.14356,0,0.23077,0), BackgroundColor3=Color3.fromRGB(43,43,43), TextColor3=Color3.fromRGB(15,102,166), Font = Enum.Font.SourceSansBold, TextSize = 14})
    btn.MouseButton1Click:Connect(function()
        pcall(callback)
    end)
    table.insert(addedControls, {type="button", ui=btn})
    return btn
end

-- Create Slider (replicates template structure)
local function CreateSlider(minVal, maxVal, defaultVal, callback)
    minVal = minVal or 0; maxVal = maxVal or 100; defaultVal = defaultVal or minVal
    local parent = SectionFrame
    local frame = new("Frame",{Parent=parent, Size=UDim2.new(0,137,0,28), BackgroundColor3=Color3.fromRGB(43,43,43), BorderSizePixel=1, Position=UDim2.new(0.14356,0,0.36779,0)})
    local knob = new("TextButton",{Parent=frame, Name="sliderKnob", Size=UDim2.new(0,7,0,21), Position=UDim2.new(-0.05109,0,-0.66667,0), BackgroundColor3=THEME, BorderSizePixel=0, Text=""})
    local valLabel = new("TextLabel",{Parent=frame, Name="SliderValue", BackgroundTransparency=1, TextColor3=Color3.new(1,1,1), Text= tostring(defaultVal), Size=UDim2.new(0,33,0,12), Position=UDim2.new(0.75912,0,-2,0)})
    local dragging = false
    knob.MouseButton1Down:Connect(function() dragging = true end)
    UserInputService.InputEnded:Connect(function(inp) if inp.UserInputType==Enum.UserInputType.MouseButton1 then dragging=false end end)
    UserInputService.InputChanged:Connect(function(inp)
        if dragging and inp.UserInputType==Enum.UserInputType.MouseMovement then
            local abs = UserInputService:GetMouseLocation()
            local pos = frame.AbsolutePosition
            local size = frame.AbsoluteSize
            local x = clamp((abs.X - pos.X)/size.X, 0, 1)
            knob.Position = UDim2.new(x, -4, -0.66667, 0)
            local value = minVal + (maxVal-minVal)*x
            valLabel.Text = string.format("%.2f", value)
            pcall(callback, value)
        end
    end)
    table.insert(addedControls, {type="slider", get=function() return tonumber(valLabel.Text) end, set=function(v) valLabel.Text = tostring(v) end})
    return {Get=function() return tonumber(valLabel.Text) end, Set=function(v) valLabel.Text = tostring(v) end, UI = frame}
end

-- Create Dropdown (uses template DropDownButton structure)
local function CreateDropdown(opts)
    opts = opts or {}
    local parent = SectionFrame
    local button = new("TextButton",{Parent=parent, Size=UDim2.new(0,104,0,17), Position=UDim2.new(0.14356,0,0.14663,0), BackgroundColor3=Color3.fromRGB(43,43,43), Text=""})
    local nameLbl = new("TextLabel",{Parent=button, Text=opts.Label or "Dropdown", BackgroundTransparency=1, Position=UDim2.new(0.02,0,0,0), Size=UDim2.new(0.6,0,1,0), TextColor3=Color3.new(1,1,1)})
    local selected = new("TextLabel",{Parent=button, Text=opts.Options and opts.Options[1] or "", BackgroundTransparency=1, Position=UDim2.new(0.6,6,0,0), Size=UDim2.new(0.35,-40,1,0), TextColor3=Color3.new(1,1,1)})
    local arrow = new("TextLabel",{Parent=button, Text="▼", Size=UDim2.new(0,24,1,0), Position=UDim2.new(1,-28,0,0), BackgroundTransparency=1, TextColor3=Color3.new(1,1,1)})
    local dropdown = new("Frame",{Parent=button, BackgroundColor3=Color3.fromRGB(43,43,43), Size=UDim2.new(1,0,0,#(opts.Options or {})*18), Position=UDim2.new(0,0,1,0), Visible=false, BorderSizePixel=1})
    for i,opt in ipairs(opts.Options or {}) do
        local btn = new("TextButton",{Parent=dropdown, Text=opt, TextColor3=Color3.new(1,1,1), Size=UDim2.new(1,0,0,18), Position=UDim2.new(0,0,(i-1)*18,0), BackgroundColor3=Color3.fromRGB(43,43,43)})
        btn.MouseButton1Click:Connect(function()
            selected.Text = opt
            dropdown.Visible = false
            if opts.Callback then pcall(opts.Callback, opt) end
        end)
    end
    button.MouseButton1Click:Connect(function() dropdown.Visible = not dropdown.Visible end)
    table.insert(addedControls, {type="dropdown", get=function() return selected.Text end, set=function(v) selected.Text = v end})
    return {Get=function() return selected.Text end, Set=function(v) selected.Text = v end, UI = button}
end

-- Config system (saves a simple snapshot in order of addedControls)
local function ensure_cfg_fs()
    safe_makefolder(CFG_ROOT)
    safe_makefolder(CFG_FOLDER)
end
local function list_cfg_files()
    ensure_cfg_fs()
    local files = safe_listfiles(CFG_FOLDER)
    local out = {}
    for _,f in ipairs(files) do
        if f:match("%.ilo$") then
            local name = f:match("([^/\\]+)%.ilo$")
            table.insert(out, name)
        end
    end
    return out
end
local function save_cfg(name, tbl)
    ensure_cfg_fs()
    local path = CFG_FOLDER.."/"..name..".ilo"
    local ok, raw = pcall(function() return HttpService:JSONEncode(tbl) end)
    if ok then
        return safe_writefile(path, raw)
    end
    return false
end
local function load_cfg(name)
    local path = CFG_FOLDER.."/"..name..".ilo"
    local raw = safe_readfile(path)
    if raw then
        local ok, tbl = pcall(function() return HttpService:JSONDecode(raw) end)
        if ok then return tbl end
    end
    return nil
end

-- Exposed API to build UI using this template
local API = {}

function API:SetTheme(c)
    THEME = c or DEFAULT_THEME
    -- only apply to known theme elements: ActiveTab and SectionName backgrounds and slider knob default for new sliders
    local side = Window:FindFirstChild("SideBar")
    if side and side:FindFirstChild("ActiveTab") then
        side.ActiveTab.BackgroundColor3 = THEME
    end
    local section = Window:FindFirstChild("Section")
    if section and section:FindFirstChild("SectionName") then
        pcall(function() section.SectionName.BackgroundColor3 = THEME end)
    end
end

function API:CreateToggle(label, opts) return CreateToggle(label, opts) end
function API:CreateButton(text, cb) return CreateButton(text, cb) end
function API:CreateSlider(min,max,default,cb) return CreateSlider(min,max,default,cb) end
function API:CreateDropdown(opts) return CreateDropdown(opts) end
function API:FadeOpen() ILO:FadeOpen() end
function API:FadeClose() ILO:FadeClose() end
function API:ToggleMenu() ILO:Toggle() end

-- Config helpers in API
function API:SaveConfig(name)
    if not name or name == "" then return false end
    local snapshot = {}
    for _,c in ipairs(addedControls) do
        if c.type == "toggle" then
            table.insert(snapshot, {type="toggle", value = c.get()})
        elseif c.type == "slider" then
            table.insert(snapshot, {type="slider", value = c.get()})
        elseif c.type == "dropdown" then
            table.insert(snapshot, {type="dropdown", value = c.get()})
        end
    end
    return save_cfg(name, snapshot)
end
function API:LoadConfig(name)
    local tbl = load_cfg(name)
    if not tbl then return false end
    local i = 1
    for _,entry in ipairs(tbl) do
        local ctrl = addedControls[i]
        if ctrl then
            if entry.type == "toggle" and ctrl.type == "toggle" then
                if ctrl.set then pcall(function() ctrl.set(entry.value) end) end
            elseif entry.type == "slider" and ctrl.type == "slider" then
                if ctrl.set then pcall(function() ctrl.set(entry.value) end) end
            elseif entry.type == "dropdown" and ctrl.type == "dropdown" then
                if ctrl.set then pcall(function() ctrl.set(entry.value) end) end
            end
        end
        i = i + 1
    end
    return true
end
function API:GetConfigList() return list_cfg_files() end

-- Expose and set default theme
API:SetTheme(DEFAULT_THEME)

-- ensure Window visible and open state
Window.Visible = true
deepTweenTransparency(Window, 0, TweenInfo.new(0)) -- ensure fully visible at init

-- return API
getgenv = getgenv or function() return _G end
getgenv().ILO = API

return API
