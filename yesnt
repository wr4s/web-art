-- ilo UI Library
-- Version: 1.0
local ilo = {}

-- Services
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

-- Internal variables
ilo.gui = nil
ilo.window = nil
ilo.activeTab = nil
ilo.tabs = {}
ilo.sections = {}
ilo.currentColorTheme = Color3.fromRGB(255, 140, 0) -- Default orange
ilo.configs = {}
ilo.menuOpen = true
ilo.selectedColorPicker = nil

-- Color picker gradient colors
ilo.gradientColors = {
	Color3.fromRGB(255, 0, 0),    -- Red
	Color3.fromRGB(255, 255, 0),  -- Yellow
	Color3.fromRGB(0, 255, 0),    -- Green
	Color3.fromRGB(0, 255, 255),  -- Cyan
	Color3.fromRGB(0, 0, 255),    -- Blue
	Color3.fromRGB(255, 0, 255),  -- Magenta
	Color3.fromRGB(255, 0, 0)     -- Back to Red
}

-- Utility functions
local function updateThemeColor()
	for _, obj in pairs(ilo.window:GetDescendants()) do
		if obj:IsA("Frame") and obj.BackgroundColor3 == Color3.fromRGB(15, 102, 166) then
			obj.BackgroundColor3 = ilo.currentColorTheme
		elseif obj:IsA("TextButton") and obj.TextColor3 == Color3.fromRGB(15, 102, 166) then
			obj.TextColor3 = ilo.currentColorTheme
		elseif obj:IsA("TextLabel") and obj.TextColor3 == Color3.fromRGB(15, 102, 166) then
			obj.TextColor3 = ilo.currentColorTheme
		end
	end
end

local function fadeWindow(fadeIn)
	local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.InOut)
	local goal = {
		BackgroundTransparency = fadeIn and 0.3 or 1,
		Visible = fadeIn
	}
	
	-- Hide all children initially if fading out
	if not fadeIn then
		for _, child in pairs(ilo.window:GetDescendants()) do
			if child:IsA("GuiObject") then
				child.Visible = false
			end
		end
	end
	
	-- Tween window
	local tween = TweenService:Create(ilo.window, tweenInfo, {BackgroundTransparency = fadeIn and 0 or 1})
	tween:Play()
	
	-- Show children with delay if fading in
	if fadeIn then
		for _, child in pairs(ilo.window:GetDescendants()) do
			if child:IsA("GuiObject") then
				child.Visible = true
			end
		end
	end
	
	tween.Completed:Wait()
	ilo.menuOpen = fadeIn
end

-- Main functions
function ilo.createWindow()
	-- Clone the existing UI structure
	ilo.gui = G2L["1"]:Clone()
	ilo.gui.Parent = game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui")
	ilo.gui.Name = "iloUI"
	
	ilo.window = ilo.gui:WaitForChild("Window")
	
	-- Get references to important elements
	ilo.activeTabIndicator = ilo.window.SideBar.ActiveTab
	
	-- Remove template elements
	for _, child in pairs(ilo.window.SideBar:GetChildren()) do
		if child:IsA("TextButton") and child.Name ~= "CheatCover" then
			child:Destroy()
		end
	end
	
	for _, child in pairs(ilo.window.Section:GetChildren()) do
		if child.Name ~= "SectionName" then
			child:Destroy()
		end
	end
	
	for _, child in pairs(ilo.window.MultiSection:GetChildren()) do
		if child.Name ~= "Frame" then
			child:Destroy()
		end
	end
	
	-- Set default color theme
	updateThemeColor()
	
	-- Toggle menu visibility
	UserInputService.InputBegan:Connect(function(input, gameProcessed)
		if not gameProcessed and input.KeyCode == Enum.KeyCode.Delete then
			ilo.menuOpen = not ilo.menuOpen
			fadeWindow(ilo.menuOpen)
		end
	end)
	
	return ilo
end

function ilo.createTab(name)
	local tabTemplate = Instance.new("TextButton")
	tabTemplate.Name = name .. "Tab"
	tabTemplate.Text = name
	tabTemplate.TextSize = 21
	tabTemplate.TextColor3 = Color3.fromRGB(255, 255, 255)
	tabTemplate.BackgroundTransparency = 1
	tabTemplate.Size = UDim2.new(0, 44, 0, 28)
	tabTemplate.Font = Enum.Font.SourceSans
	tabTemplate.BorderSizePixel = 0
	
	-- Position calculation
	local sideBar = ilo.window.SideBar
	local yPosition = 0.25726 + (#ilo.tabs * 0.08714)
	tabTemplate.Position = UDim2.new(0.27, 0, yPosition, 0)
	tabTemplate.Parent = sideBar
	
	-- Store tab data
	local tabData = {
		name = name,
		button = tabTemplate,
		sections = {},
		multiSections = {}
	}
	
	table.insert(ilo.tabs, tabData)
	
	-- Set first tab as active
	if #ilo.tabs == 1 then
		ilo.setActiveTab(name)
	end
	
	-- Tab click event
	tabTemplate.MouseButton1Click:Connect(function()
		ilo.setActiveTab(name)
	end)
	
	return tabData
end

function ilo.setActiveTab(tabName)
	for _, tab in pairs(ilo.tabs) do
		if tab.name == tabName then
			-- Move active indicator
			ilo.activeTabIndicator.Position = tab.button.Position + UDim2.new(0, 0, 0, 28)
			ilo.activeTab = tab
			
			-- Show/Hide sections
			for _, section in pairs(ilo.sections) do
				if section.parentTab == tabName then
					section.frame.Visible = true
				else
					section.frame.Visible = false
				end
			end
		end
	end
end

function ilo.createSection(tabName, sectionName, multiSection)
	local tab = nil
	for _, t in pairs(ilo.tabs) do
		if t.name == tabName then
			tab = t
			break
		end
	end
	
	if not tab then return end
	
	local sectionFrame
	if multiSection then
		sectionFrame = ilo.window.MultiSection:Clone()
		sectionFrame.Name = sectionName .. "Section"
		sectionFrame.Position = UDim2.new(0.61765, 0, 0.09544, 0)
		sectionFrame.Visible = false
	else
		sectionFrame = ilo.window.Section:Clone()
		sectionFrame.Name = sectionName .. "Section"
		sectionFrame.Position = UDim2.new(0.23039, 0, 0.09544, 0)
		sectionFrame.Visible = false
	end
	
	sectionFrame.Parent = ilo.window
	sectionFrame.SectionName.TextLabel.Text = sectionName
	
	local sectionData = {
		name = sectionName,
		frame = sectionFrame,
		parentTab = tabName,
		isMultiSection = multiSection,
		elements = {},
		yOffset = 0.08
	}
	
	table.insert(ilo.sections, sectionData)
	
	if multiSection then
		table.insert(tab.multiSections, sectionData)
	else
		table.insert(tab.sections, sectionData)
	end
	
	return sectionData
end

function ilo.createMultiSection(tabName, sectionName, subSectionNames)
	local section = ilo.createSection(tabName, sectionName, true)
	if not section then return end
	
	section.subSections = {}
	section.activeSubSection = 1
	
	local buttonWidth = 68
	if #subSectionNames > 3 then
		buttonWidth = 202 / #subSectionNames
	end
	
	for i, subName in pairs(subSectionNames) do
		local button = Instance.new("TextButton")
		button.Name = subName .. "Btn"
		button.Text = subName
		button.TextSize = 14
		button.TextColor3 = Color3.fromRGB(255, 255, 255)
		button.BackgroundColor3 = Color3.fromRGB(43, 43, 41)
		button.Font = Enum.Font.SourceSans
		button.BorderSizePixel = 1
		button.BorderColor3 = Color3.fromRGB(0, 0, 0)
		button.Size = UDim2.new(0, buttonWidth, 0, 34)
		button.Position = UDim2.new((buttonWidth * (i-1)) / 202, 0, -0.07212, 0)
		button.Parent = section.frame
		
		local subSection = {
			name = subName,
			button = button,
			elements = {},
			yOffset = 0.08
		}
		
		table.insert(section.subSections, subSection)
		
		button.MouseButton1Click:Connect(function()
			section.activeSubSection = i
			-- Hide all elements
			for _, elem in pairs(section.elements) do
				if elem.gui then
					elem.gui.Visible = false
				end
			end
			-- Show elements of this subsection
			for _, elem in pairs(subSection.elements) do
				if elem.gui then
					elem.gui.Visible = true
				end
			end
		end)
	end
	
	-- Show first subsection by default
	if #section.subSections > 0 then
		section.activeSubSection = 1
	end
	
	return section
end

function ilo.createToggle(sectionData, options)
	local toggleTemplate = ilo.window.Section.ToggleButton:Clone()
	toggleTemplate.Name = options.Name or "Toggle"
	toggleTemplate.ToggleName.Text = options.Text or "Toggle"
	toggleTemplate.Position = UDim2.new(0.08416, 0, sectionData.yOffset, 0)
	toggleTemplate.Parent = sectionData.frame
	toggleTemplate.BackgroundColor3 = Color3.fromRGB(43, 43, 43)
	
	sectionData.yOffset = sectionData.yOffset + 0.07
	
	local toggleState = options.Default or false
	local toggleData = {
		name = options.Name,
		state = toggleState,
		gui = toggleTemplate,
		callback = options.Callback,
		colorPicker = nil,
		bind = nil
	}
	
	if sectionData.isMultiSection then
		table.insert(sectionData.subSections[sectionData.activeSubSection].elements, toggleData)
	else
		table.insert(sectionData.elements, toggleData)
	end
	
	-- Update visual state
	local function updateVisual()
		if toggleState then
			toggleTemplate.BackgroundColor3 = ilo.currentColorTheme
		else
			toggleTemplate.BackgroundColor3 = Color3.fromRGB(43, 43, 43)
		end
	end
	
	updateVisual()
	
	-- Add color picker if requested
	if options.ColorPicker then
		local colorPicker = ilo.window.Section.ColorPicker:Clone()
		colorPicker.Name = options.Name .. "ColorPicker"
		colorPicker.Position = UDim2.new(0.10891, 0, sectionData.yOffset - 0.07, 0)
		colorPicker.BackgroundColor3 = options.ColorPickerDefault or Color3.fromRGB(255, 255, 255)
		colorPicker.Parent = sectionData.frame
		
		toggleData.colorPicker = {
			gui = colorPicker,
			color = options.ColorPickerDefault or Color3.fromRGB(255, 255, 255),
			callback = options.ColorPickerCallback
		}
		
		colorPicker.MouseButton1Click:Connect(function()
			ilo.openColorPicker(toggleData)
		end)
	end
	
	-- Add bind if requested
	if options.Bind then
		local bindBtn = ilo.window.Section.Bind:Clone()
		bindBtn.Name = options.Name .. "Bind"
		bindBtn.Position = UDim2.new(0.10891, 0, sectionData.yOffset - 0.07, 0)
		if options.ColorPicker then
			bindBtn.Position = UDim2.new(0.10891, 0, sectionData.yOffset - 0.07, 0) + UDim2.new(0.2, 0, 0, 0)
		end
		bindBtn.Parent = sectionData.frame
		
		local bindData = {
			gui = bindBtn,
			key = options.BindDefault or Enum.KeyCode.Unknown,
			mode = options.BindMode or "Toggle",
			callback = options.BindCallback,
			active = false,
			listening = false
		}
		
		toggleData.bind = bindData
		
		bindBtn.MouseButton1Click:Connect(function()
			bindData.listening = true
			bindBtn.Text = "..."
		end)
		
		-- Bind options menu
		local optionsMenu = bindBtn.BindOptions:Clone()
		optionsMenu.Parent = bindBtn
		optionsMenu.Visible = false
		
		bindBtn.MouseButton2Click:Connect(function()
			optionsMenu.Visible = not optionsMenu.Visible
		end)
		
		-- Bind mode selection
		for _, modeBtn in pairs(optionsMenu:GetChildren()) do
			if modeBtn:IsA("TextButton") then
				modeBtn.MouseButton1Click:Connect(function()
					bindData.mode = modeBtn.Text
					optionsMenu.Visible = false
				end)
			end
		end
		
		-- Key binding
		UserInputService.InputBegan:Connect(function(input, gameProcessed)
			if not gameProcessed and bindData.listening then
				if input.UserInputType == Enum.UserInputType.Keyboard then
					bindData.key = input.KeyCode
					bindBtn.Text = input.KeyCode.Name
					bindData.listening = false
				end
			end
		end)
	end
	
	toggleTemplate.MouseButton1Click:Connect(function()
		toggleState = not toggleState
		updateVisual()
		if toggleData.callback then
			toggleData.callback(toggleState)
		end
	end)
	
	-- Return functions to control the toggle
	return {
		set = function(state)
			toggleState = state
			updateVisual()
			if toggleData.callback then
				toggleData.callback(toggleState)
			end
		end,
		get = function()
			return toggleState
		end
	}
end

function ilo.createButton(sectionData, options)
	local buttonTemplate = ilo.window.Section.Button:Clone()
	buttonTemplate.Name = options.Name or "Button"
	buttonTemplate.Text = options.Text or "Button"
	buttonTemplate.Position = UDim2.new(0.14356, 0, sectionData.yOffset, 0)
	buttonTemplate.Parent = sectionData.frame
	buttonTemplate.TextColor3 = ilo.currentColorTheme
	
	sectionData.yOffset = sectionData.yOffset + 0.08
	
	local buttonData = {
		name = options.Name,
		gui = buttonTemplate,
		callback = options.Callback
	}
	
	if sectionData.isMultiSection then
		table.insert(sectionData.subSections[sectionData.activeSubSection].elements, buttonData)
	else
		table.insert(sectionData.elements, buttonData)
	end
	
	buttonTemplate.MouseButton1Click:Connect(function()
		if buttonData.callback then
			buttonData.callback()
		end
	end)
	
	return buttonData
end

function ilo.createSlider(sectionData, options)
	local sliderTemplate = ilo.window.Section.Slider:Clone()
	sliderTemplate.Name = options.Name or "Slider"
	sliderTemplate.Position = UDim2.new(0.14356, 0, sectionData.yOffset, 0)
	sliderTemplate.Parent = sectionData.frame
	
	sectionData.yOffset = sectionData.yOffset + 0.08
	
	local value = options.Default or options.Min or 0
	local min = options.Min or 0
	local max = options.Max or 100
	local sliderData = {
		name = options.Name,
		value = value,
		min = min,
		max = max,
		gui = sliderTemplate,
		knob = sliderTemplate.sliderKnob,
		callback = options.Callback
	}
	
	if sectionData.isMultiSection then
		table.insert(sectionData.subSections[sectionData.activeSubSection].elements, sliderData)
	else
		table.insert(sectionData.elements, sliderData)
	end
	
	-- Update display
	local function updateDisplay()
		local percentage = ((value - min) / (max - min))
		sliderData.knob.Position = UDim2.new(percentage, 0, -0.66667, 0)
		sliderTemplate.SliderValue.Text = string.format("%.1f %%", percentage * 100)
	end
	
	updateDisplay()
	
	-- Slider dragging
	local dragging = false
	
	sliderData.knob.MouseButton1Down:Connect(function()
		dragging = true
	end)
	
	UserInputService.InputEnded:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)
	
	UserInputService.InputChanged:Connect(function(input)
		if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
			local mousePos = UserInputService:GetMouseLocation()
			local sliderAbsPos = sliderTemplate.AbsolutePosition
			local sliderSize = sliderTemplate.AbsoluteSize
			
			local relativeX = (mousePos.X - sliderAbsPos.X) / sliderSize.X
			relativeX = math.clamp(relativeX, 0, 1)
			
			value = min + (relativeX * (max - min))
			if options.Precise then
				value = math.floor(value)
			end
			
			updateDisplay()
			if sliderData.callback then
				sliderData.callback(value)
			end
		end
	end)
	
	-- Return control functions
	return {
		set = function(newValue)
			value = math.clamp(newValue, min, max)
			updateDisplay()
			if sliderData.callback then
				sliderData.callback(value)
			end
		end,
		get = function()
			return value
		end
	}
end

function ilo.createDropdown(sectionData, options)
	local dropdownTemplate = ilo.window.Section.DropDownButton:Clone()
	dropdownTemplate.Name = options.Name or "Dropdown"
	dropdownTemplate.DropdownName.Text = options.Text or "Dropdown"
	dropdownTemplate.Position = UDim2.new(0.14356, 0, sectionData.yOffset, 0)
	dropdownTemplate.Parent = sectionData.frame
	
	sectionData.yOffset = sectionData.yOffset + 0.08
	
	local selected = options.Default or 1
	local items = options.Options or {"Option 1", "Option 2", "Option 3"}
	local dropdownData = {
		name = options.Name,
		items = items,
		selected = selected,
		gui = dropdownTemplate,
		dropdownFrame = dropdownTemplate.DropDownFrame,
		callback = options.Callback
	}
	
	if sectionData.isMultiSection then
		table.insert(sectionData.subSections[sectionData.activeSubSection].elements, dropdownData)
	else
		table.insert(sectionData.elements, dropdownData)
	end
	
	-- Populate dropdown
	local yPos = 0
	for i, item in pairs(items) do
		local optionBtn = dropdownData.dropdownFrame["option" .. math.min(i, 4)]:Clone()
		if i > 4 then
			optionBtn = dropdownData.dropdownFrame.option1:Clone()
			optionBtn.Name = "option" .. i
			optionBtn.Parent = dropdownData.dropdownFrame
		end
		optionBtn.Text = item
		optionBtn.Position = UDim2.new(0, 0, yPos, 0)
		optionBtn.Visible = true
		
		optionBtn.MouseButton1Click:Connect(function()
			selected = i
			dropdownTemplate.DropdownName.Text = item
			dropdownData.dropdownFrame.Visible = false
			if dropdownData.callback then
				dropdownData.callback(item, i)
			end
		end)
		
		yPos = yPos + 0.22576
	end
	
	-- Toggle dropdown
	dropdownTemplate.MouseButton1Click:Connect(function()
		dropdownData.dropdownFrame.Visible = not dropdownData.dropdownFrame.Visible
	end)
	
	-- Close dropdown when clicking outside
	UserInputService.InputBegan:Connect(function(input, gameProcessed)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			if dropdownData.dropdownFrame.Visible then
				local mousePos = UserInputService:GetMouseLocation()
				local framePos = dropdownData.dropdownFrame.AbsolutePosition
				local frameSize = dropdownData.dropdownFrame.AbsoluteSize
				
				if not (mousePos.X >= framePos.X and mousePos.X <= framePos.X + frameSize.X and
					   mousePos.Y >= framePos.Y and mousePos.Y <= framePos.Y + frameSize.Y) then
					dropdownData.dropdownFrame.Visible = false
				end
			end
		end
	end)
	
	-- Return control functions
	return {
		set = function(index)
			if index >= 1 and index <= #items then
				selected = index
				dropdownTemplate.DropdownName.Text = items[index]
				if dropdownData.callback then
					dropdownData.callback(items[index], index)
				end
			end
		end,
		get = function()
			return selected, items[selected]
		end
	}
end

function ilo.openColorPicker(toggleData)
	-- Close any existing color picker
	if ilo.colorPickerFrame then
		ilo.colorPickerFrame:Destroy()
	end
	
	-- Create color picker frame
	local colorFrame = Instance.new("Frame")
	colorFrame.Name = "ColorPickerFrame"
	colorFrame.Size = UDim2.new(0, 300, 0, 350)
	colorFrame.Position = UDim2.new(0.5, -150, 0.5, -175)
	colorFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
	colorFrame.BorderSizePixel = 1
	colorFrame.BorderColor3 = Color3.fromRGB(60, 60, 60)
	colorFrame.Parent = ilo.gui
	colorFrame.ZIndex = 100
	
	-- Title
	local title = Instance.new("TextLabel")
	title.Text = "Color Picker"
	title.TextSize = 18
	title.TextColor3 = Color3.fromRGB(255, 255, 255)
	title.BackgroundTransparency = 1
	title.Size = UDim2.new(1, 0, 0, 30)
	title.Parent = colorFrame
	
	-- Gradient canvas
	local gradientFrame = Instance.new("Frame")
	gradientFrame.Size = UDim2.new(0, 250, 0, 250)
	gradientFrame.Position = UDim2.new(0.5, -125, 0, 40)
	gradientFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
	gradientFrame.BorderSizePixel = 1
	gradientFrame.BorderColor3 = Color3.fromRGB(100, 100, 100)
	gradientFrame.Parent = colorFrame
	
	-- Create gradient
	local uigradient = Instance.new("UIGradient")
	uigradient.Color = ColorSequence.new(ilo.gradientColors)
	uigradient.Rotation = 90
	uigradient.Parent = gradientFrame
	
	-- Selection circle
	local selection = Instance.new("Frame")
	selection.Size = UDim2.new(0, 10, 0, 10)
	selection.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
	selection.BorderSizePixel = 2
	selection.BorderColor3 = Color3.fromRGB(0, 0, 0)
	selection.Parent = gradientFrame
	selection.ZIndex = 101
	
	-- RGB input
	local rgbFrame = Instance.new("Frame")
	rgbFrame.Size = UDim2.new(0, 250, 0, 30)
	rgbFrame.Position = UDim2.new(0.5, -125, 0, 300)
	rgbFrame.BackgroundTransparency = 1
	rgbFrame.Parent = colorFrame
	
	local rgbBox = Instance.new("TextBox")
	rgbBox.Size = UDim2.new(0.6, 0, 1, 0)
	rgbBox.PlaceholderText = "R G B (e.g., 42 42 42)"
	rgbBox.TextSize = 14
	rgbBox.TextColor3 = Color3.fromRGB(255, 255, 255)
	rgbBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
	rgbBox.Parent = rgbFrame
	
	-- Buttons
	local buttonFrame = Instance.new("Frame")
	buttonFrame.Size = UDim2.new(0, 250, 0, 30)
	buttonFrame.Position = UDim2.new(0.5, -125, 0, 310)
	buttonFrame.BackgroundTransparency = 1
	buttonFrame.Parent = colorFrame
	
	local cancelBtn = Instance.new("TextButton")
	cancelBtn.Text = "Cancel"
	cancelBtn.Size = UDim2.new(0, 80, 0, 25)
	cancelBtn.Position = UDim2.new(0, 0, 0, 0)
	cancelBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
	cancelBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
	cancelBtn.Parent = buttonFrame
	
	local selectBtn = Instance.new("TextButton")
	selectBtn.Text = "Select"
	selectBtn.Size = UDim2.new(0, 80, 0, 25)
	selectBtn.Position = UDim2.new(1, -80, 0, 0)
	selectBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
	selectBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
	selectBtn.Parent = buttonFrame
	
	-- Gradient interaction
	local function getColorAtPosition(pos)
		local x = math.clamp(pos.X, 0, 1)
		local y = math.clamp(pos.Y, 0, 1)
		
		-- Calculate color based on position
		local hue = x
		local saturation = y
		local value = 1 - (y * 0.5)
		
		return Color3.fromHSV(hue, saturation, value)
	end
	
	gradientFrame.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			local mousePos = UserInputService:GetMouseLocation()
			local framePos = gradientFrame.AbsolutePosition
			local frameSize = gradientFrame.AbsoluteSize
			
			local relativeX = (mousePos.X - framePos.X) / frameSize.X
			local relativeY = (mousePos.Y - framePos.Y) / frameSize.Y
			
			selection.Position = UDim2.new(relativeX, -5, relativeY, -5)
			
			local color = getColorAtPosition(Vector2.new(relativeX, relativeY))
			selection.BackgroundColor3 = color
			
			-- Update RGB box
			local r, g, b = math.floor(color.r * 255), math.floor(color.g * 255), math.floor(color.b * 255)
			rgbBox.Text = string.format("%d %d %d", r, g, b)
		end
	end)
	
	-- RGB box input
	rgbBox.FocusLost:Connect(function(enterPressed)
		if enterPressed then
			local parts = string.split(rgbBox.Text, " ")
			if #parts == 3 then
				local r = tonumber(parts[1]) or 255
				local g = tonumber(parts[2]) or 255
				local b = tonumber(parts[3]) or 255
				
				r = math.clamp(r, 0, 255)
				g = math.clamp(g, 0, 255)
				b = math.clamp(b, 0, 255)
				
				local color = Color3.fromRGB(r, g, b)
				selection.BackgroundColor3 = color
			end
		end
	end)
	
	-- Button actions
	cancelBtn.MouseButton1Click:Connect(function()
		colorFrame:Destroy()
		ilo.colorPickerFrame = nil
	end)
	
	selectBtn.MouseButton1Click:Connect(function()
		local selectedColor = selection.BackgroundColor3
		
		-- Update toggle's color picker
		if toggleData.colorPicker then
			toggleData.colorPicker.gui.BackgroundColor3 = selectedColor
			toggleData.colorPicker.color = selectedColor
			if toggleData.colorPicker.callback then
				toggleData.colorPicker.callback(selectedColor)
			end
		end
		
		colorFrame:Destroy()
		ilo.colorPickerFrame = nil
	end)
	
	-- Close when clicking outside
	UserInputService.InputBegan:Connect(function(input, gameProcessed)
		if input.UserInputType == Enum.UserInputType.MouseButton1 and ilo.colorPickerFrame then
			local mousePos = UserInputService:GetMouseLocation()
			local framePos = colorFrame.AbsolutePosition
			local frameSize = colorFrame.AbsoluteSize
			
			if not (mousePos.X >= framePos.X and mousePos.X <= framePos.X + frameSize.X and
				   mousePos.Y >= framePos.Y and mousePos.Y <= framePos.Y + frameSize.Y) then
				colorFrame:Destroy()
				ilo.colorPickerFrame = nil
			end
		end
	end)
	
	ilo.colorPickerFrame = colorFrame
end

-- Config system
function ilo.saveConfig(name)
	local config = {}
	
	-- Save all toggle states
	for _, section in pairs(ilo.sections) do
		for _, element in pairs(section.elements) do
			if element.get then
				config[element.name] = element.get()
			end
		end
	end
	
	ilo.configs[name] = config
	
	-- Save to file if using a save system
	if writefile then
		writefile("ilo_" .. name .. ".json", HttpService:JSONEncode(config))
	end
	
	return config
end

function ilo.loadConfig(name)
	local config = ilo.configs[name]
	if not config and readfile then
		local success, data = pcall(function()
			return HttpService:JSONDecode(readfile("ilo_" .. name .. ".json"))
		end)
		if success then
			config = data
		end
	end
	
	if config then
		-- Apply config
		for _, section in pairs(ilo.sections) do
			for _, element in pairs(section.elements) do
				if config[element.name] ~= nil and element.set then
					element.set(config[element.name])
				end
			end
		end
		return true
	end
	return false
end

function ilo.deleteConfig(name)
	ilo.configs[name] = nil
	if delfile then
		pcall(function()
			delfile("ilo_" .. name .. ".json")
		end)
	end
end

function ilo.getConfigs()
	local configList = {}
	for name, _ in pairs(ilo.configs) do
		table.insert(configList, name)
	end
	
	-- Check for file configs
	if listfiles then
		for _, file in pairs(listfiles()) do
			if string.find(file, "ilo_") and string.find(file, ".json") then
				local configName = string.match(file, "ilo_(.-)%.json")
				if configName and not ilo.configs[configName] then
					table.insert(configList, configName)
				end
			end
		end
	end
	
	return configList
end

-- Set color theme
function ilo.setColorTheme(color)
	ilo.currentColorTheme = color
	updateThemeColor()
end

-- Get current color theme
function ilo.getColorTheme()
	return ilo.currentColorTheme
end

-- Toggle menu visibility
function ilo.toggleMenu()
	ilo.menuOpen = not ilo.menuOpen
	fadeWindow(ilo.menuOpen)
end

-- Set menu keybind
function ilo.setMenuKey(keyCode)
	-- Remove old binding
	UserInputService.InputBegan:Connect(function(input, gameProcessed)
		if not gameProcessed and input.KeyCode == keyCode then
			ilo.toggleMenu()
		end
	end)
end

-- Initialize library
return ilo
